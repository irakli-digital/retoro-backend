# Railway Deployment Guide

## Prerequisites

1. Railway account: https://railway.app
2. Neon Database already set up (you have this)
3. Git repository initialized

## Deployment Steps

### 1. Connect to Railway

```bash
# Install Railway CLI (optional)
npm i -g @railway/cli

# Login
railway login
```

### 2. Deploy from GitHub (Recommended)

1. Push your code to GitHub
2. Go to https://railway.app/new
3. Select "Deploy from GitHub repo"
4. Choose your repository
5. Railway will auto-detect Next.js and deploy

### 3. Configure Environment Variables

In Railway dashboard, add these environment variables:

**Required:**
```
DATABASE_URL=<your-neon-database-url>
JWT_SECRET=<your-jwt-secret>
JWT_REFRESH_SECRET=<your-jwt-refresh-secret>
NODE_ENV=production
APPLE_BUNDLE_ID=com.retoro.retoro
```

**Optional (Third-party services):**
```
GOOGLE_CLIENT_ID=<your-google-client-id>
GOOGLE_CLIENT_SECRET=<your-google-client-secret>
RESEND_API_KEY=<your-resend-api-key>
EMAIL_FROM=noreply@retoro.app
N8N_INVOICE_WEBHOOK_URL=<your-n8n-webhook-url>
RETORO_API_KEY=<your-api-key>
```

**Auto-generated by Railway:**
```
PORT (Railway sets this automatically)
RAILWAY_ENVIRONMENT=production
```

### 4. Update iOS App

Once deployed, Railway will give you a URL like `https://retoro-backend-production.up.railway.app`

Update your iOS app's `AuthManager.swift` and `APIClient.swift`:

```swift
// For production
private let baseURL = "https://retoro-backend-production.up.railway.app"

// For development
// private let baseURL = "http://127.0.0.1:3000"
```

### 5. Verify Deployment

Test the API:
```bash
curl https://your-railway-url.railway.app/api/retailers
```

## Database Migration

Railway will automatically run `npm run build` which includes Next.js build.

The OAuth migration was already applied to your Neon database locally, so no additional migration is needed.

## Monitoring

- Railway Dashboard: https://railway.app/dashboard
- View logs in real-time
- Monitor resource usage
- Set up custom domains

## Custom Domain (Optional)

1. Go to your Railway project settings
2. Add custom domain
3. Update DNS records with your domain provider
4. Railway provides automatic HTTPS

## Troubleshooting

**Build fails:**
- Check Railway logs
- Verify all dependencies in package.json
- Ensure Node version compatibility (Railway uses Node 18+)

**Database connection fails:**
- Verify DATABASE_URL is set correctly
- Check Neon database is accessible
- Ensure SSL mode is enabled

**API returns 500:**
- Check environment variables are set
- Review Railway logs for errors
- Verify JWT secrets are set

## Cost

Railway free tier includes:
- $5 of usage per month
- Automatic scaling
- 1GB RAM, 1 vCPU

For production, consider upgrading to Pro plan ($20/month).
